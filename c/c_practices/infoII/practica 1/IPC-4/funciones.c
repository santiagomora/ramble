/**********************************************************************************************************************************
 *
 * @file		funciones.c
 * @brief		Descripcion del modulo
 * @date		02-05-2020
 * @author		Luis Mora
 *
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** INCLUDES
 **********************************************************************************************************************************/
#include "funciones.h"

/***********************************************************************************************************************************
 *** DEFINES PRIVADOS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** MACROS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TIPOS DE DATOS PRIVADOS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TABLAS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PUBLICAS
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** PROTOTIPO DE FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/
/**
    \fn     handlerHijo
    \brief  Escribe TIEMPO_DE_VIDA numeros aleatorios en el pipe
            para que sean leidos por el padre.
    \author Luis Mora
    \date 02-05-2020
    \param [in] int fd file descriptor del pipe de escritura
    \return 0 si hay exito, 1 si hay un error;
*/
void handlerHijo( int fd ){
    char buf[BUFSIZE];
    srand( time(NULL) );
    printf("ESPERANDO MENSAJES:\n");
    for ( int ctr=0; ctr<TIEMPO_DE_VIDA; ctr++ ){
        sprintf( buf,"%d",rand()%LIMSUP+LIMINF );
        escribefd( fd,buf,strlen(buf) );
        sleep(1);
    }
    cierrapipe( fd );
    exit(0);
}

/**
    \fn     handlerPadre
    \brief  Lee TIEMPO_DE_VIDA numeros aleatorios escritos
            por el proceso hijo en el pipe.
    \author Luis Mora
    \date 02-05-2020
    \param [in] int fd file descriptor del pipe de lectura
    \return 0 si hay exito, 1 si hay un error;
*/
void handlerPadre( int fd ){
    int sz,ctr=0;
    char buf[BUFSIZE];
    while( ctr<TIEMPO_DE_VIDA ){
        sz = leefd( fd,buf,BUFSIZE );
        buf[sz] = '\0';
        ctr++;
        printf( "mensaje[%d]:%s\n",ctr,buf );
    }
}

 /***********************************************************************************************************************************
 *** FUNCIONES GLOBALES AL MODULO
 **********************************************************************************************************************************/
/**
    \fn     crearHijo
    \brief  Crea el pipe y el proceso hijo de escritura.
    \author Luis Mora
    \date 02-05-2020
    \return 0 si hay exito, 1 si es interrumpido;
*/
int crearHijo( ){
    int pipefd[2];
    creapipe( pipefd );
    if ( fork() )
        handlerPadre( pipefd[0] );
    else
        handlerHijo( pipefd[1] );
    cierrapipe( pipefd[0] );
    exit(0);
}

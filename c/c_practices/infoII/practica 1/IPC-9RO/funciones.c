/**********************************************************************************************************************************
 *
 * @file		funciones.c
 * @brief		Descripcion del modulo
 * @date		02-05-2020
 * @author		Luis Mora
 *
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** INCLUDES
 **********************************************************************************************************************************/
#include "funciones.h"

/***********************************************************************************************************************************
 *** DEFINES PRIVADOS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** MACROS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TIPOS DE DATOS PRIVADOS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TABLAS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PUBLICAS
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** PROTOTIPO DE FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/
/**
    \fn     imprime
    \brief  muestra los nuevos mensajes en pantalla
    \author Luis Mora
    \date 02-05-2020
    \param [in] struct msj m mensaje recibido
*/
void imprime( struct msj m ){
    printf("\
INICIO DE MENSAJE:\n\
    Tipo de mensaje:%ld\n\
    Contenido de mensaje:%s\
    Fecha de envio:%s\
FIN DE MENSAJE.\n",
     m.mtype,m.mtext,m.fecha);
}

/**
    \fn     espera
    \brief  Lee los mensajes que no tengan tipo 100 en el msgtype
            y los imprime en la pantalla
    \author Luis Mora
    \date 02-05-2020
    \param [in] void
    \param [out]
    \return 0 si hay exito, 1 si hay error de recepcion;
*/
int espera( int cid ){
    int ctr=0;
    struct msj buf;
    while( leemensaje( cid,&buf,sizeof( struct msj ),MSGTYPE,MSG_EXCEPT )>=0 ){
        printf( "Mensaje [%d] recibido:\n",++ctr );
        imprime( buf );
    }
    return 0;
}

 /***********************************************************************************************************************************
 *** FUNCIONES GLOBALES AL MODULO
 **********************************************************************************************************************************/
/**
    \fn     abre
    \brief  Abre la cola de mensajes previamente creada por el
            proceso que lee los mensajes tipo 100. Debe ejecutarse
            luego de este ultimo de lo contrario puede que no encuentre
            los archivos para generacion de llave ni el id de cola
    \author Luis Mora
    \date 02-05-2020
    \return 0 si hay exito, 1 si hay error obteniendo la cola o generando la llave;
*/
int abre( ){
    int cid = obtencola( KEYFILE,PRKEY );
    printf("ESPERANDO MENSAJES ENVIADOS:\n");
    espera( cid );
    exit(0);
}

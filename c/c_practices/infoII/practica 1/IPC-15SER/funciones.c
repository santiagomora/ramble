/**********************************************************************************************************************************
 *
 * @file		funciones.c
 * @brief		Descripcion del modulo
 * @date		02-05-2020
 * @author		Luis Mora
 *
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** INCLUDES
 **********************************************************************************************************************************/
#include "funciones.h"

/***********************************************************************************************************************************
 *** DEFINES PRIVADOS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** MACROS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TIPOS DE DATOS PRIVADOS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TABLAS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PUBLICAS
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** PROTOTIPO DE FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/**
    \fn     terminar
    \brief  finaliza el programa
    \author Luis Mora
    \date   06-05-2020
    \param [in] int sig seÃ±al SIGUSR1
    \return 0 si hay exito, 1 si hay un error;
*/
void terminar( int sig ){
    while( wait(NULL)>0 );
    exit(1);
}

/**
    \fn     enviar
    \brief  Envia un numero aleatorio al socket
    \author Luis Mora
    \date   06-05-2020
    \return 0 si hay exito, 1 si hay un error;
*/
int enviar( int sock ){
    int rnd;
    srand( time( NULL ) );
    for (int i=0; i<VALENV; i++ ){
        rnd = rand()%6+1;
        escribefd( sock,&rnd,sizeof( int ) );
        printf("ENVIADO:%d\n",rnd);
        sleep(1);
    }
    cerrartcp( sock );
    exit(0);
}

 /***********************************************************************************************************************************
 *** FUNCIONES GLOBALES AL MODULO
 **********************************************************************************************************************************/

/**
    \fn     levantar
    \brief  Inicia el servidor con protocolo TCP
    \author Luis Mora
    \date   06-05-2020
    \return 0 si hay exito, 1 si hay un error;
*/
int levantar( char* ip ){
    int clisock,sockfd = creasockettcp();
    struct sockaddr_in seradr,cliadr;
    socklen_t clilen;
    nombrartcp( sockfd,PUERTO,&seradr,ip );
    signal( SIGUSR1,terminar );
    signal( SIGTERM,terminar );
    if ( escuchartcp( sockfd,MAXCONN,ip ) == 0 ) {
        printf("SERVIDOR LEVANTADO EN: %s\n",ip);
        while (1) {
            if ( ( clisock = aceptartcp( sockfd,&clilen,&cliadr ) )>=0 ){
                if ( !fork() )
                    enviar( clisock );
                else
                    printf("CONEXION ESTABLECIDA\n");
            }
        }
    }
    cerrartcp( sockfd );
    return 0;
}
